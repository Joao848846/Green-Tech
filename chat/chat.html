<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Chat WhatsApp</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #e0e0e0; /* Cor de fundo do WhatsApp */
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }

      .whatsapp-container {
        width: 90%;
        max-width: 450px; /* Largura típica de um celular */
        height: 600px; /* Altura para simular a tela */
        background: #f0f2f5; /* Um tom mais claro para o container */
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        background-color: #ededed;
        padding: 10px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #d3d3d3;
      }

      .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
      }

      .contact-info {
        flex-grow: 1;
      }

      .contact-name {
        font-weight: bold;
      }

      .chat-body {
        flex-grow: 1;
        padding: 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .message {
        clear: both;
        margin-bottom: 10px;
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 16px;
        line-height: 1.3;
        max-width: 80%; /* Para não ocupar toda a largura */
      }

      .received {
        background-color: #fff; /* Cor das mensagens recebidas */
        float: left;
        align-self: flex-start;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
      }

      .sent {
        background-color: #dcf8c6; /* Cor das suas mensagens */
        float: right;
        align-self: flex-end;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
      }

      .message-content {
        word-break: break-word;
      }

      .message-timestamp {
        font-size: 12px;
        color: #777;
        text-align: right;
        margin-top: 5px;
      }

      .chat-footer {
        background-color: #f0f0f0;
        padding: 10px;
        border-top: 1px solid #d3d3d3;
        display: flex;
        align-items: center;
      }

      .input-container {
        flex-grow: 1;
        margin-right: 10px;
      }

      .input-container input {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 20px;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        box-sizing: border-box;
      }

      .chat-footer button {
        background-color: #00a884; /* Cor do botão de enviar do WhatsApp */
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 18px;
      }

      .chat-footer button:hover {
        background-color: #008069;
      }
    </style>
  </head>
  <body>
    <div class="whatsapp-container">
      <div class="chat-header">
        <img
          src="https://via.placeholder.com/40"
          alt="Contato"
          class="profile-pic"
        />
        <div class="contact-info">
          <div class="contact-name">João Victor</div>
        </div>
      </div>

      <div id="chat" class="chat-body">
        <div class="message received initial-message">
          Aguardando mensagens...
        </div>
      </div>

      <div class="chat-footer">
        <div class="input-container">
          <input
            type="text"
            id="messageInput"
            placeholder="Digite uma mensagem"
          />
        </div>
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
    </div>

    <script>
      let stompClient = null;
      const numeroFixo = "5511911031972"; // Número fixo para o vídeo

      function conectarWs() {
        const socket = new SockJS("http://localhost:3000/ws");
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Desativa logs no console

        stompClient.connect({}, () => {
          stompClient.subscribe("/topic/messages", (messageOutput) => {
            const data = JSON.parse(messageOutput.body);
            adicionarMensagemAoChat(data);
          });
        });
      }

      function adicionarMensagemAoChat(data) {
        const chat = document.getElementById("chat");
        const initialMessage = document.querySelector("#chat .initial-message");
        if (initialMessage) {
          initialMessage.remove(); // Remove a mensagem inicial ao receber a primeira mensagem
        }

        const msg = document.createElement("div");
        msg.classList.add("message");
        if (data.fromMe) {
          msg.classList.add("sent");
        } else {
          msg.classList.add("received");
        }

        const messageContentDiv = document.createElement("div");
        messageContentDiv.classList.add("message-content");
        messageContentDiv.textContent = data.conversation || "(sem conteúdo)";

        const timestampDiv = document.createElement("div");
        timestampDiv.classList.add("message-timestamp");
        timestampDiv.textContent = data.dateTime || "Sem data";

        msg.appendChild(messageContentDiv);
        msg.appendChild(timestampDiv);
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight; // Scroll automático para a última mensagem
      }

      async function enviarMensagem() {
        const text = document.getElementById("messageInput").value;

        if (text.trim() !== "") {
          const payload = {
            number: numeroFixo,
            text: text,
          };

          try {
            const response = await fetch(
              "http://localhost:3000/api/v1/message/sendText/Joao",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
              }
            );

            if (!response.ok) {
              alert("❌ Erro ao enviar: " + response.status);
            } else {
              document.getElementById("messageInput").value = ""; // Limpar o campo de texto
              // Simulando a mensagem enviada na tela (opcional, o backend pode enviar de volta)
              const sentMessage = {
                conversation: text,
                fromMe: true,
                dateTime: new Date().toLocaleTimeString(), // Simulação de timestamp
              };
              adicionarMensagemAoChat(sentMessage);
            }
          } catch (error) {
            alert("Erro de rede: " + error.message);
          }
        }
      }

      conectarWs();
    </script>
  </body>
</html>
