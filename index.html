<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Agendamentos Inteligentes</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #181818; /* Tema escuro e elegante */
        color: #f0f0f0;
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        grid-gap: 20px;
      }

      .widget {
        background-color: #282828;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease-in-out;
      }

      .widget:hover {
        transform: scale(1.02);
      }

      .widget-title {
        font-size: 1.4em;
        font-weight: bold;
        margin-bottom: 15px;
        color: #eee;
        border-bottom: 2px solid #444;
        padding-bottom: 5px;
      }

      .metric-value {
        font-size: 3em;
        font-weight: bold;
        color: #00bfff; /* Azul vibrante */
        animation: pulse 1.5s infinite alternate;
      }

      @keyframes pulse {
        0% {
          opacity: 0.8;
        }
        100% {
          opacity: 1;
        }
      }

      .metric-label {
        color: #999;
        margin-top: 8px;
        font-size: 0.9em;
      }

      /* Widget de Status de Pagamentos (Donut Chart Placeholder) */
      #status-pagamentos-chart {
        height: 150px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #777;
        font-style: italic;
        border: 2px dashed #555;
        border-radius: 50%;
        margin: 10px auto;
        width: 150px;
      }

      /* Widget de Tipos de Contrato (Bar Chart Placeholder) */
      #tipos-contrato-chart {
        height: 120px;
        border-left: 2px solid #555;
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        margin-top: 10px;
      }
      .bar {
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 5px 5px 0 0;
        font-size: 0.8em;
      }

      /* Widget de Agendamentos Recentes */
      .recent-agendamentos ul {
        list-style: none;
        padding: 0;
      }

      .recent-agendamentos li {
        padding: 10px 0;
        border-bottom: 1px solid #444;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideIn 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
      }

      @keyframes slideIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .recent-agendamentos li:last-child {
        border-bottom: none;
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: bold;
      }
      .status-pago {
        background-color: #4caf50;
        color: #222;
      }
      .status-pendente {
        background-color: #ffc107;
        color: #333;
      }
      .status-atrasado {
        background-color: #f44336;
        color: #eee;
      }

      /* Paginação */
      #pagination-controls {
        margin-top: 15px;
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      #pagination-controls button {
        padding: 8px 16px;
        border: 1px solid #666;
        border-radius: 5px;
        background-color: #333;
        color: #eee;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      #pagination-controls button.active {
        background-color: #00bfff;
        border-color: #00bfff;
      }

      #pagination-controls button:hover:not(.active) {
        background-color: #555;
      }
    </style>
  </head>
  <body>
    <h1>Dashboard de Agendamentos Inteligentes</h1>
    <div class="dashboard-container">
      <div class="widget">
        <div class="widget-title">Total de Agendamentos</div>
        <div class="metric-value" id="total-agendamentos">Carregando...</div>
        <div class="metric-label">Número total de agendamentos ativos</div>
      </div>

      <div class="widget">
        <div class="widget-title">Status de Pagamentos</div>
        <div id="status-pagamentos-chart">Gráfico de Pagamentos</div>
        <div class="metric-label" style="text-align: center">
          Distribuição dos status de pagamento
        </div>
        <div
          style="display: flex; justify-content: space-around; margin-top: 10px"
        >
          <span id="pagos-count" class="status-pago status-badge"
            >Pagos: Carregando...</span
          >
          <span id="pendentes-count" class="status-pendente status-badge"
            >Pendentes: Carregando...</span
          >
          <span id="atrasados-count" class="status-atrasado status-badge"
            >Atrasados: Carregando...</span
          >
        </div>
      </div>

      <div class="widget">
        <div class="widget-title">Tipos de Contrato</div>
        <div id="tipos-contrato-chart">
          <div class="bar" style="height: 30%" id="mensal-count">Mensal</div>
          <div class="bar" style="height: 60%" id="semestral-count">
            Semestral
          </div>
          <div class="bar" style="height: 90%" id="anual-count">Anual</div>
        </div>
        <div class="metric-label" style="text-align: center">
          Distribuição por tipo de contrato
        </div>
      </div>

      <div class="widget recent-agendamentos">
        <div class="widget-title">Agendamentos Recentes</div>
        <ul id="lista-recentes"></ul>
        <div id="pagination-controls"></div>
      </div>

      <div class="widget">
        <div class="widget-title">Lembretes Enviados</div>
        <div class="metric-value" id="lembretes-enviados-count">
          Carregando...
        </div>
        <div class="metric-label">Total de lembretes enviados</div>
      </div>

      <div class="widget">
        <div class="widget-title">Lembretes Não Enviados</div>
        <div class="metric-value" id="lembretes-nao-enviados-count">
          Carregando...
        </div>
        <div class="metric-label">Total de lembretes não enviados</div>
      </div>
    </div>

    <script>
      // Função para exibir os agendamentos recentes com paginação
      function exibirAgendamentosRecentes(
        agendamentos,
        pagina = 1,
        itensPorPagina = 5
      ) {
        const listaRecentes = document.getElementById("lista-recentes");
        listaRecentes.innerHTML = "";

        const startIndex = (pagina - 1) * itensPorPagina;
        const endIndex = startIndex + itensPorPagina;
        const agendamentosPagina = agendamentos.slice(startIndex, endIndex);

        agendamentosPagina.forEach((agendamento) => {
          const listItem = document.createElement("li");
          const statusClass = `status-${agendamento.statusPagamento.toLowerCase()}`;
          const dataUltimoLembrete = agendamento.dataUltimoLembreteEnviado
            ? new Date(
                agendamento.dataUltimoLembreteEnviado
              ).toLocaleDateString("pt-BR", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
              })
            : "Nunca Enviado";

          listItem.innerHTML = `
                    <span>${agendamento.nome}</span>
                    <div>
                        <span class="status-badge ${statusClass}">${agendamento.statusPagamento}</span>
                        <small style="color: #999; margin-left: 10px;">Último Lembrete: ${dataUltimoLembrete}</small>
                    </div>
                `;
          listaRecentes.appendChild(listItem);
        });

        // Lógica de paginação
        const totalPaginas = Math.ceil(agendamentos.length / itensPorPagina);
        const paginationControls = document.getElementById(
          "pagination-controls"
        );
        paginationControls.innerHTML = "";

        if (totalPaginas > 1) {
          for (let i = 1; i <= totalPaginas; i++) {
            const button = document.createElement("button");
            button.textContent = i;
            if (i === pagina) {
              button.classList.add("active");
            }
            button.addEventListener("click", () => {
              exibirAgendamentosRecentes(agendamentos, i);
            });
            paginationControls.appendChild(button);
          }
        }
      }

      // Chamadas para os endpoints
      fetch("http://localhost:3000/api/v1/csv/agendamentos")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("total-agendamentos").textContent =
            data.length;
          exibirAgendamentosRecentes(data);
        });

      fetch(
        "http://localhost:3000/api/v1/csv/agendamentos/status_pagamento/count?status_pagamento=pago"
      )
        .then((response) => response.json())
        .then((data) => {
          const element = document.getElementById("pagos-count");
          if (element) element.textContent = `Pagos: ${data}`;
        });

      fetch(
        "http://localhost:3000/api/v1/csv/agendamentos/status_pagamento/count?status_pagamento=pendente"
      )
        .then((response) => response.json())
        .then((data) => {
          const element = document.getElementById("pendentes-count");
          if (element) element.textContent = `Pendentes: ${data}`;
        });

      fetch(
        "http://localhost:3000/api/v1/csv/agendamentos/status_pagamento/count?status_pagamento=atrasado"
      )
        .then((response) => response.json())
        .then((data) => {
          const element = document.getElementById("atrasados-count");
          if (element) element.textContent = `Atrasados: ${data}`;
        });

      // Novos endpoints de contagem de lembretes
      fetch(
        "http://localhost:3000/api/v1/csv/agendamentos/lembrete/count?lembrete_enviado=true"
      )
        .then((response) => response.json())
        .then((data) => {
          const element = document.getElementById("lembretes-enviados-count");
          if (element) element.textContent = data;
        });

      fetch(
        "http://localhost:3000/api/v1/csv/agendamentos/lembrete/count?lembrete_enviado=false"
      )
        .then((response) => response.json())
        .then((data) => {
          const element = document.getElementById(
            "lembretes-nao-enviados-count"
          );
          if (element) element.textContent = data;
        });

      // Simulação dos gráficos de barra (Tipos de Contrato - precisaríamos de um endpoint para a contagem por tipo)
      // Os valores fixos são apenas para dar uma ideia visual
      fetch("http://localhost:3000/api/v1/csv/agendamentos")
        .then((response) => response.json())
        .then((data) => {
          const mensal = data.filter(
            (item) => item.tipo_contrato === "mensal"
          ).length;
          const semestral = data.filter(
            (item) => item.tipo_contrato === "semestral"
          ).length;
          const anual = data.filter(
            (item) => item.tipo_contrato === "anual"
          ).length;

          const total = mensal + semestral + anual;

          document.getElementById("mensal-count").style.height =
            `${(mensal / total) * 80 + 20}%`;
          document.getElementById("mensal-count").textContent =
            `Mensal (${mensal})`;

          document.getElementById("semestral-count").style.height =
            `${(semestral / total) * 80 + 20}%`;
          document.getElementById("semestral-count").textContent =
            `Semestral (${semestral})`;

          document.getElementById("anual-count").style.height =
            `${(anual / total) * 80 + 20}%`;
          document.getElementById("anual-count").textContent =
            `Anual (${anual})`;
        });

      // Simulação do gráfico de donut (Status de Pagamentos - precisaríamos de um endpoint para a contagem por status)
      fetch("http://localhost:3000/api/v1/csv/agendamentos")
        .then((response) => response.json())
        .then((data) => {
          const pagos = data.filter(
            (item) => item.statusPagamento === "pago"
          ).length;
          const pendentes = data.filter(
            (item) => item.statusPagamento === "pendente"
          ).length;
          const atrasados = data.filter(
            (item) => item.statusPagamento === "atrasado"
          ).length;

          // Aqui você integraria uma biblioteca de gráficos como Chart.js para criar o donut real
          const chartElement = document.getElementById(
            "status-pagamentos-chart"
          );
          if (chartElement) chartElement.textContent = "Gráfico de Pagamentos"; // Placeholder até a biblioteca ser integrada
        });
    </script>
  </body>
</html>
